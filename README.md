# æ¬¢è¿ä½¿ç”¨ `Py_heart`
**Py_heart** æ˜¯ä¸€ä¸ªä½¿ç”¨ Python å¼€å‘çš„ é€‚ç”¨äºéµå®ˆ [Bluetooth Heart Rate Service 1.0](https://www.bluetooth.com/specifications/specs/heart-rate-service-1.0/) åè®®çš„ BLE å¿ƒç‡è®¾å¤‡çš„ Windows ç«¯å·¥å…·ï¼Œå°¤å…¶æ˜¯ `Xiaomi Smart Band 9` å’Œ `Xiaomi Smart Band 10`çš„å·¥å…·ã€‚è½»é‡ä¸”å¼ºå¤§ï¼›å†…ç½®ç½‘é¡µç«¯æ§åˆ¶å°ï¼Œæ”¯æŒTUIå’ŒGUI åŒç«¯æŸ¥çœ‹ï¼›å¼€æ”¾apiæ”¯æŒç¬¬ä¸‰æ–¹ç¨‹åºè·å–ã€‚

---



## **å¦‚ä½•ä½¿ç”¨**

### 1. æ‰“å¼€ç¨‹åº `py_heart_x.x.exe`ï¼Œç­‰å¾…ç¨‹åºåœ¨è”ç½‘è·å–æœ€æ–°ç‰ˆæœ¬å ï¼Œ å¼€å§‹æ‰«æè®¾å¤‡ `([xxxx/xx/xx xx:xx.xx.xxx] æ‰«æè®¾å¤‡...... )`  ä¹‹åæ“ä½œæ‰‹è¡¨ã€‚

### 2. åœ¨æ‰‹ç¯ > è®¾ç½® > å¿ƒç‡å¹¿æ’­ > å¼€å¯ åç­‰å¾…è¿æ¥æˆåŠŸï¼Œæ­¤è¿‡ç¨‹å¤§æ¦‚ 1-5s ã€‚ç­‰å¾…è¾“å‡ºä¸ä¸‹æ–‡ç±»ä¼¼çš„æ–‡æœ¬å³ä¸ºè¿æ¥æˆåŠŸã€‚

```js
[2025/10/18 15:55.38.133] æ‰¾åˆ°è®¾å¤‡: C4:D3:4C:B8:9A:E2: Xiaomi ï¿½ï¿½ï¿½ï¿½
[2025/10/18 15:55.38.133] è¿æ¥è®¾å¤‡ä¸­: C4:D3:4C:B8:9A:E2
[2025/10/18 15:55.43.826] æˆåŠŸè¿æ¥è®¾å¤‡ï¼

```
### 3. æµè§ˆå™¨æ‰“å¼€ ç›‘å¬åœ°å€(http://127.0.0.1:6123) ï¼Œ ä½ ä¼šçœ‹è§å¦‚ä¸‹å›¾
![alt text](image.png)

### 4. æ­å–œä½ ï¼ ä½ å·²ç»å®Œæˆäº†åŸºæ“ï¼


---
## æ³¨æ„äº‹é¡¹

- ### `è¿æ¥é”™è¯¯: 'BLEDevice' object has no attribute 'metadata'`ï¼šè¿™æ˜¯åœ¨æ—©æœŸçš„bleakåº“ä¸­ï¼Œä½œä¸ºä¸€ä¸ªBleakScanner ä¸­è·å–å¹¿å‘Šè€Œæ— éœ€æ·»åŠ å›è°ƒçš„ã€‚([æºç½‘é¡µ](https://github.com/hbldh/bleak/issues/1025))

- ### è§£é‡Šä¸€ä¸‹ï¼Œè¿™å…¶ä¸­çš„ `band_name` æ˜¯å¿ƒç‡è®¾å¤‡è“ç‰™åœ°å€å’Œè®¾å¤‡è“ç‰™åæ··åˆçš„ç»“æœï¼Œ`device_connected` å°±æ˜¯å¿ƒç‡è®¾å¤‡æ˜¯å¦è¿æ¥ï¼Œè¿”å›çš„æ˜¯å¸ƒå°”å€¼boolï¼›`heart_rate` å°±æ˜¯å¿ƒç‡ï¼›`sensor_contact_1`å°±æ˜¯æ‹¿çš„â€œå¹¿æ’­æ•°æ®â€é‡Œé¢çš„ `flag & 0b00100` , ä½†æ˜¯æˆ‘æ”¹äº†å¾ˆä¹…çš„bugï¼ŒåŒ…æ‹¬ä½¿ç”¨äº†å…¶ä»–äººçš„è½¯ä»¶ï¼Œä¸€ç›´éƒ½æ˜¯è¾“å‡ºçš„Trueï¼›æ‰€ä»¥æˆ‘åˆæ·»åŠ äº†ä¸€ä¸ª `sensor_contact_2` ï¼Œè¿™ä¸ªå°±æ˜¯åˆ¤æ–­å¿ƒç‡å€¼æ˜¯å¦ä¸ºé›¶ï¼Œæ²¡æœ‰å…¶ä»–æ­¥éª¤ï¼Œå»ºè®®åœ¨å®é™…åº”ç”¨æ—¶åˆ¤æ–­`sensor_contact_1`ä¸`sensor_contact_2`æ˜¯å¦éƒ½ä¸ºTrue
```js
{
  "band_name": "C4:D3:4C:B8:9A:E2: Xiaomi Smart Band 5C35",
  "device_connected": true,
  "heart_rate": 83,
  "sensor_contact_1": true,
  "sensor_contact_2": true,
  "timestamp": "2025-10-18T18:13:01.493901"
}
```

- ### æˆ‘apiæ–‡æ¡£ä¸­å†™çš„GET æ˜¯çœŸçš„ä»…é™GETï¼Œä¸è¦å°è¯•ç”¨POSTè·å–ã€‚

- ### è®¾å¤‡åæœ‰æ—¶ä¹±ç ï¼Œä¾‹å¦‚ `Xiaomi ï¿½ï¿½ï¿½ï¿½` ï¼Œè¿™æ˜¯æ­£å¸¸ç°è±¡ï¼Œä¸ä¼šå½±å“ç¨‹åºè¿è¡Œï¼Œåˆæ­¥åˆ¤æ–­é—®é¢˜åº”è¯¥æ˜¯åœ¨bleakä¸­å¤„ç†è“ç‰™è®¾å¤‡åä¸­æœ‰å­˜åœ¨ç©ºæ ¼çš„æƒ…å†µã€‚

- ### éƒ¨åˆ†å¿ƒç‡è®¾å¤‡çš„è“ç‰™åœ°å€æ˜¯é”™è¯¯çš„ï¼Œè¿™å¹¶ä¸æ˜¯ç¨‹åºã€è“ç‰™ç¡¬ä»¶æˆ–ç³»ç»Ÿçš„é—®é¢˜ï¼Œè¿™å¤§æ¦‚æ˜¯æ‰‹ç¯å‚å®¶ä¸ºé˜²æ­¢macåœ°å€æ³„éœ²è€Œå¯¼è‡´é»‘å®¢è®¾å¤‡æ— é™è¿æ¥æ‰‹ç¯å§ï¼Œåæ­£åœ¨æˆ‘çš„Xiaomi Smart Band 9 NFC ä¸­å¯ä»¥å‘ç°ï¼Œä½ ä»¬ä¹Ÿå¯ä»¥å‘ç°åœ¨ä¸Šæ–¹çš„ `image-1.png`ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘çš„è®¾å¤‡çœŸå®åœ°å€æ˜¯????5c35ç»“å°¾ï¼Œè€Œå®ƒæ˜¾ç¤ºçš„æ˜¯ `C4:D3:4C:B8:9A:E2`(è¿™å°±æ˜¯æˆ‘ä¸æ‰“ç çš„åŸå› ) 

- ### ä½œè€…æ²¡é’±ä¹°æœåŠ¡å™¨ï¼Œæ‰€ä»¥ä½œè€…ä½¿ç”¨çš„æ˜¯å…è´¹ç©ºé—´æ­å»ºçš„æ›´æ–°æœåŠ¡å™¨ï¼ˆå…è´¹ç©ºé—´ä½äºç¾å›½ åŠ åˆ©ç¦å°¼äºš æ´›æ‰çŸ¶ Telusï¼‰ï¼Œéƒ¨åˆ†åœ°åŒºä¼šè¶…æ—¶ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶é™„åŠ å‚æ•° `-no_update` é¿å…æ›´æ–°
![alt text](image-2.png)

- ### åœ¨æ˜¾ç¤ºå¦‚ä¸‹å›¾ è‡³ æ˜¾ç¤ºè¿æ¥æˆåŠŸæ—¶æ–­å¼€è¿æ¥ï¼Œç¨‹åºä¼šå› ä¸ºæ¥æ”¶ä¸åˆ°å“åº”å¯¼è‡´ä¸ä¼šè¾“å‡ºä»»ä½•ä¸œè¥¿ä¹Ÿä¸ä¼šé€€å‡ºï¼ˆæˆ‘æ‡’å¾—åšè¶…æ—¶çš„è§£å†³æ–¹æ³•,dogeï¼‰
```js
[2025/10/18 16:09.46.852] æ‰¾åˆ°è®¾å¤‡: C4:D3:4C:B8:9A:E2: Xiaomi Smart Band 9 5C35
[2025/10/18 16:09.46.852] è¿æ¥è®¾å¤‡ä¸­: C4:D3:4C:B8:9A:E2
[2025/10/18 16:09.47.911] æˆåŠŸè¿æ¥è®¾å¤‡ï¼
[2025/10/18 16:09.47.911] å¼€å¯TUIè¾“å‡ºæœåŠ¡
```
- ### åªå»ºè®®åœ¨è¿æ¥å¿ƒç‡è®¾å¤‡æ—¶ï¼Œä½¿ç”¨ TUI ï¼Œåœ¨å…¶ä»–æ—¶å€™æ›´å»ºè®®ä½¿ç”¨æµè§ˆå™¨

- ### è¯¥å·¥å…·ç†è®ºä¸Šé€‚ç”¨äºæ‰€æœ‰éµå®ˆ [Bluetooth Heart Rate Service 1.0](https://www.bluetooth.com/specifications/specs/heart-rate-service-1.0/) åè®®çš„ BLE å¿ƒç‡è®¾å¤‡ ï¼Œ æ³¨æ„æ˜¯ *ç†è®ºä¸Š* ï¼Œä¸æ’é™¤æŸäº›å‚å®¶å°†å¿ƒç‡æ•°æ®æ”¾åœ¨ *å¹¿æ’­æ•°æ®çš„å‚å•†è‡ªå®šä¹‰æ•°æ®*  ä¸­
- ### åœ¨å°ç±³æ‰‹ç¯4-7ä»£ä¸­ ï¼Œ è¿åŠ¨å¿ƒç‡å¹¿æ’­æ˜¯çœŸæ­£åŒ…å«åœ¨ BLE å¹¿æ’­æ•°æ®ä¸­çš„ ï¼› ä½†æ˜¯åœ¨9-10ä»£ä¸­(ç›®å‰)åªåŒ…å«äº†[Bluetooth Heart Rate Service](https://www.bluetooth.com/specifications/specs/heart-rate-service-1.0/)å£°æ˜å’Œè®¾å¤‡åç§°ï¼ˆå¿ƒç‡å¹¿æ’­ç•Œé¢ä¸­ç°è‰²å­—ä½“é‚£ä¸ªï¼‰ï¼Œå…¶ä»–è®¾å¤‡éœ€è¦å…ˆè¿æ¥æ‰èƒ½è·å–å¿ƒç‡

- ### å¯ä»¥ç”¨ WebBluetooth ç®€å•æ¨¡æ‹Ÿä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹ï¼Œåœ¨Chromeæˆ–è€…Edgeæµè§ˆå™¨çš„æ§åˆ¶å°ä¸­è¾“å…¥ä»¥ä¸‹ä»£ç ï¼š 
```js
(async () => {
  const device = await navigator.bluetooth.requestDevice({filters: [{ services: ["heart_rate"] }]});
  console.log(device.name);
  const gatt = await device.gatt.connect();
  const hrs = await gatt.getPrimaryService("heart_rate");
  const hrm = await hrs.getCharacteristic("00002a37-0000-1000-8000-00805f9b34fb");
  hrm.addEventListener("characteristicvaluechanged", event => console.log(event.target.value));
  hrm.startNotifications();
})(); 
```
- ### è·å¾—çš„Heart Rate Measurement æ•°æ®ä¹Ÿå¹¶ä¸ç›´æ¥æ˜¯å¿ƒç‡æ•°æ®ï¼Œè¿˜éœ€è¦è§£æï¼š

- ### ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯ Flags Fieldï¼Œå…¶ä¸­bit0ä»£è¡¨å¿ƒç‡æ•°æ®æ ¼å¼ï¼Œ0ä»£è¡¨å¿ƒç‡æ•°æ®æ˜¯u8ï¼Œ1ä»£è¡¨å¿ƒç‡æ•°æ®æ˜¯u16ï¼›bit1ä»£è¡¨ä¼ æ„Ÿå™¨æ¥è§¦æ£€æµ‹ï¼Œ0ä»£è¡¨ä¼ æ„Ÿå™¨ä¸çš®è‚¤æ¥è§¦ä¸è‰¯ï¼Œ1ä»£è¡¨ä¼ æ„Ÿå™¨ä¸çš®è‚¤æ¥è§¦è‰¯å¥½ï¼›bit2ä»£è¡¨ä¼ æ„Ÿå™¨æ˜¯å¦æ”¯æŒæ¥è§¦æ£€æµ‹ï¼Œ0ä»£è¡¨ä¸æ”¯æŒï¼Œ1ä»£è¡¨æ”¯æŒï¼›ä½™ä¸‹çš„bitè¿™é‡Œä¸ä½œä»‹ç»

- ### ç¬¬äºŒåˆ°ä¸‰ä¸ªå­—èŠ‚ä»£è¡¨å¿ƒç‡æ•°æ®ï¼Œå…·ä½“é•¿åº¦å–å†³äºFlags Fieldçš„bit0

- ### ç¬¬ 6 ç‚¹ä»¥åæˆ‘æ˜¯å‚è€ƒTnzeå¤§ä½¬çš„å¸–å­ [ğŸ”—å°ç±³æ‰‹ç¯å¿ƒç‡ç›´æ’­ miband-heart-rate.exe çš„é«˜çº§ä½¿ç”¨æ–¹æ³•](https://www.bilibili.com/read/cv42151192)(ç‚¹å‡»ç›´è¾¾)

## è¿›é˜¶æ“ä½œ

- ### GET `/heart_rate_data` - è·å–å½“å‰å¿ƒç‡æ•°æ® ï¼Œ ä»¥ `json` æ ¼å¼è¿”å›å„é¡¹æ•°æ®ï¼Œ `device_connected`ã€ `sensor_contact_1` å’Œ `sensor_contact_2` è¿”å›éƒ½ä¸ºå¸ƒå°”å€¼ï¼›`heart_rate`è¿”å›ä¸ºæ•´æ•°å‹
```js
{
  "band_name": "C4:D3:4C:B8:9A:E2: Xiaomi Smart Band 5C35",
  "device_connected": true,
  "heart_rate": 83,
  "sensor_contact_1": true,
  "sensor_contact_2": true,
  "timestamp": "2025-10-18T18:13:01.493901"
}
```
- ### GET `/health` - è·å–å½“å‰ç¨‹åºçŠ¶æ€ ï¼Œ ä»¥ `json` æ ¼å¼è¿”å›å„é¡¹æ•°æ®ï¼Œ`device_connected`è¿”å›ä¸ºå¸ƒå°”å€¼
```js
{
  "device_connected": true,
  "status": "running",
  "timestamp": "2025-10-18T18:21:05.067044"
}
```

- ### GET `/detail/<detail>` - è·å–å½“å‰ç¨‹åºçŠ¶æ€ ï¼Œ ä»¥ `json` æ ¼å¼è¿”å›å„é¡¹æ•°æ®ï¼Œè¿”å›å€¼ä¸º `json` ä¸­çš„ `number` æˆ– `string`, ç»  `jsonify` å¤„ç†.å¯è·å–ä¿¡æ¯æœ‰`device_name`ã€`rate`ã€`sc1`ã€`sc2` ã€`version`(ç³»ç»Ÿç‰ˆæœ¬ä¿¡æ¯)
```js
83
```


## æ›´æ–°æ—¥å¿—
### 2025/10/18
- ### ?????? å†™éº»äº†ã€‚è¿˜æœ‰è¿™tuiæ˜¯çœŸçš„ä¹±ï¼Œæ§åˆ¶å°1ç§’è¯·æ±‚è·å–4ä¸ªå‚æ•°ï¼Œobsç«¯500msè¯·æ±‚1ä¸ªå¿ƒç‡å‚æ•°

![ç›å¾·çå‡ æŠŠä¸ºäº†æŠŠhtmlæŒ¤åˆ°ä¸€å—æˆ‘ç›´æ¥æ€’å†™1000è¡Œ](image-1.png)
![666 ä¸€ç§’6ä¸ªè¯·æ±‚ï¼Œè¿™ä¸ªå…¥æ˜¯æ¡‚](image-3.png)
